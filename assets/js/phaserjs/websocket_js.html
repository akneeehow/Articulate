<script>
    const STREAM = navigator.mediaDevices.getUserMedia({video: true, audio: true});
    const peers = {};
    
    // Fetching Endpoint
    let loc = window.location;
    let wsStart = 'ws://';
    if (loc.protocol === 'https:') {
        wsStart = 'wss://';
    }
    let endpoint = wsStart + loc.host + loc.pathname;
    
    let socket = new WebSocket("ws://127.0.0.1:8000");
    let my_peer;
    
    // Promises
    const getMyPeerId = new Promise((resolve) => {
        my_peer = new Peer(undefined, {
            host: "127.0.0.1",
            port: '9000'
        });
    
        my_peer.on('open', (uid) => {
            console.log("My peer ID is: ", uid);
            resolve(uid);
        });
    });
    
    const openSocket = new Promise((resolve) => {
        socket.addEventListener("open", (e) => {
            resolve();
        });
    });

    if (socket.readyState === WebSocket.OPEN) {
        console.log("WebSocket connection is open");
      } else {
        console.log("WebSocket connection is not open");
      }
    
    Promise.all([getMyPeerId, openSocket]).then(([myUniquePeerId]) => {
        console.log("open");
        let data = {
            "status": "user_new",
            "message": "New user entered the room.",
            "data": {
                "new_user_username" : "{{ user.username }}",
                "unique_peer_id": myUniquePeerId,
                "game_room_unique_id": "{{ game_room.unique_game_id }}"
            }
        };
        let response = {"type": "user.new", "text": data};
        socket.send(JSON.stringify(response));
    
        STREAM.then(stream => {
            addVideoStream(stream, "{{ user.username }}");
        });
    });
    
    VideoGrid = document.getElementById('VideoGrid');
    
    function addVideoStream(stream, label="Some user in Room") {
        let video = document.createElement('video');
        video.srcObject = stream;
        video.addEventListener('loadedmetadata', () => {
            video.play();
        });
    
        let newVideoCont = document.createElement('div');
        newVideoCont.style.cssText = `
            display: inline-block;
            box-sizing: border-box;
            width: 100px;
        `;
    
        let newVideoLabel = document.createElement('p');
        newVideoLabel.textContent = label;
    
        VideoGrid.append(newVideoCont);
        newVideoCont.append(newVideoLabel);
        newVideoCont.id = "div_" + label;
        newVideoLabel.id = label;
        video.id = "vid_" + label;
        newVideoCont.append(video);
    
        if (label === "{{ user.username }}") {
            video.muted = true;
        }
    }
    
    function connectToNewUser(otherUniquePeerId, newUserName) {
        if (myUniquePeerId === otherUniquePeerId) {
            return;
        }
    
        STREAM.then(stream => {
            setTimeout(() => {
                const call = my_peer.call(otherUniquePeerId, stream, {metadata: {"username": "{{user.username}}"}});
    
                const othersVideo = document.createElement('video');
                call.on('stream', remoteStream => {
                    if (peers[newUserName]) {
                        console.log("Second Call");
                    } else {
                        addVideoStream(remoteStream, newUserName);
                        peers[newUserName] = call;
                    }
                });
    
                call.on('close', () => {
                    othersVideo.remove();
                });
            }, 2000);
        });
    }
    
    STREAM.then(stream => {
        my_peer.on('call', call => {
            let caller = call.metadata.username;
            call.answer(stream);
            const othersVideo = document.createElement('video');
            call.on('stream', remoteStream => {
                if (peers[caller] !== undefined) {
                    console.log("Already answered once");
                } else {
                    peers[caller] = call;
                    addVideoStream(remoteStream, caller);
                }
            });
        });
    });
    
    socket.addEventListener("message", function (e) {
        let backendResponse = JSON.parse(e.data);
        let status = backendResponse.status;
        let message = backendResponse.message;
        let data = backendResponse.data;
        let gameData;
    
        if (backendResponse.gameData) {
            gameData = JSON.parse(backendResponse.gameData);
            if (currentGame == null) {
                currentGame = new Game(gameData);
            }
        }
    
        let username, pk, elementToAppend;
    
        if (status === "user_left_room") {
            let leftUserUsername = data.left_user_username;
            if (peers[leftUserUsername]) {
                peers[leftUserUsername].close();
                delete peers[leftUserUsername];
                let divElement = document.getElementById("div_" + leftUserUsername);
                if (divElement) {
                    divElement.remove();
                }
                let vidElement = document.getElementById("vid_" + leftUserUsername);
                if (vidElement) {
                    vidElement.remove();
                }
            } else {
                console.log("That user does not exist");
            }
            let
        }
        
    else if(status === "user_new") {
        let unique_peer_id = data.unique_peer_id;
        let game_room_unique_id = data.game_room_unique_id;
        let new_user_username = data.new_user_username;
        connectToNewUser(unique_peer_id, new_user_username);
        currentGame.connectPlayer(new_user_username);
    }
    else if(status === "broadcast_notification") {
        elementToAppend = `<li>${message}</li>`;
        notificationList.append(elementToAppend);
    }
});

socket.onerror = function (e) {
    console.log("error");
};

socket.onclose = function (e) {
    console.log("close");
};
</script>